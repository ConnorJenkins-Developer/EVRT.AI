<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client Portal — EVRT</title>
  <meta name="description" content="Secure portal for EVRT consulting clients." />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet"/>
  <!-- Reuse site styles -->
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <div class="bg-orbs" aria-hidden="true"></div>
  <!-- Reuse your site header/footer via partials -->
  <div data-include="partials/header.html"></div>

  <section class="container hero">
    <span class="eyebrow">Clients</span>
    <h1 class="gradient-text">Client Portal</h1>
    <p class="sub">Sign in to view deliverables, messages, and reports.</p>
    <div class="hero-cta"></div>
  </section>

  <section class="container section" id="auth">
    <div class="card" data-reveal>
      <h3>Sign in</h3>
      <p class="muted">Use your work email. We'll send you a magic link.</p>
      <form id="login-form" class="grid" style="gap:10px">
        <input id="email" type="email" placeholder="you@company.com" required />
        <button class="btn primary" type="submit">Send magic link</button>
      </form>
      <div id="auth-msg" class="muted" style="margin-top:10px"></div>
    </div>
  </section>

  <section class="container section" id="app" style="display:none">
    <div class="grid grid-2">
      <div class="card" data-reveal>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Your Projects</h3>
          <button id="signout" class="btn">Sign out</button>
        </div>
        <p class="muted">Projects you have access to.</p>
        <div id="projects"></div>
      </div>
      <div class="card" data-reveal>
        <h3>Documents</h3>
        <p class="muted">Reports, files, and deliverables.</p>
        <div id="documents"></div>
        <div style="margin-top:10px">
          <label class="btn">
            <input id="file-input" type="file" style="display:none" />
            Upload file
          </label>
        </div>
      </div>
    </div>

    <div class="card" data-reveal style="margin-top:16px">
      <h3>Messages</h3>
      <div id="messages" class="prose" style="max-height:280px;overflow:auto"></div>
      <form id="msg-form" style="display:flex;gap:8px;margin-top:8px">
        <input id="msg-text" placeholder="Write a message…" required />
        <button class="btn primary">Send</button>
      </form>
    </div>
  </section>

  <div data-include="partials/footer.html"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Your site JS for partials/nav/theme/reveal -->
  <script defer src="assets/app.js"></script>

  <script>
  // ---- Configure these two values once you create the Supabase project ----
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // TODO
  const SUPABASE_ANON_KEY = "public-anon-key"; // TODO
  // ------------------------------------------------------------------------

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $auth = document.getElementById('auth');
  const $app  = document.getElementById('app');
  const $msg  = document.getElementById('auth-msg');

  // Handle magic-link return
  async function handleHashSession(){
    const { data: { session }, error } = await supabase.auth.getSession();
    if (session) return true;
    const { data, error: ex } = await supabase.auth.getUser();
    return !!data?.user;
  }

  function setAuthedUI(isAuthed){
    $auth.style.display = isAuthed ? 'none' : '';
    $app.style.display  = isAuthed ? '' : 'none';
  }

  // Login form (magic link)
  document.getElementById('login-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    $msg.textContent = 'Sending…';
    const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
    $msg.textContent = error ? ('Error: ' + error.message) : 'Check your email for a sign-in link.';
  });

  document.getElementById('signout').addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    setAuthedUI(false);
  });

  // Data helpers
  async function listProjects(){
    const { data, error } = await supabase.from('projects').select('id,name,status').order('updated_at', { ascending:false });
    const el = document.getElementById('projects');
    if (error) { el.innerHTML = `<p class="muted">${error.message}</p>`; return; }
    el.innerHTML = (data||[]).map(p=>`<div class="row"><strong>${p.name}</strong><span class="muted">${p.status||''}</span></div>`).join('') || '<p class="muted">No projects yet.</p>';
  }

  async function listDocuments(){
    const { data, error } = await supabase.from('documents').select('id,name,storage_path,created_at').order('created_at', { ascending:false });
    const el = document.getElementById('documents');
    if (error) { el.innerHTML = `<p class="muted">${error.message}</p>`; return; }
    // Signed URLs for private downloads (adjust bucket name)
    const items = await Promise.all((data||[]).map(async d=>{
      try {
        const { data: urlData } = await supabase.storage.from('client-docs').createSignedUrl(d.storage_path, 60*10);
        return `<div class="row"><a href="${urlData?.signedUrl||'#'}">${d.name}</a><span class="muted">${new Date(d.created_at).toLocaleDateString()}</span></div>`
      } catch { return `<div class="row">${d.name}</div>`; }
    }));
    el.innerHTML = items.join('') || '<p class="muted">No documents yet.</p>';
  }

  // Upload (restricted by Storage policy)
  document.getElementById('file-input').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if (!f) return;
    const path = `${Date.now()}_${f.name}`;
    const { error } = await supabase.storage.from('client-docs').upload(path, f, { upsert:false });
    if (error) alert(error.message); else { await supabase.from('documents').insert({ name: f.name, storage_path: path }); listDocuments(); }
    e.target.value = '';
  });

  // Messaging (very simple demo)
  async function loadMessages(){
    const { data, error } = await supabase.from('messages').select('id,body,created_at,author_name').order('created_at', { ascending:false }).limit(50);
    const el = document.getElementById('messages');
    el.innerHTML = (data||[]).map(m=>`<p><strong>${m.author_name||'You'}</strong> <span class="muted">${new Date(m.created_at).toLocaleString()}</span><br>${m.body}</p>`).join('');
  }
  document.getElementById('msg-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const t = document.getElementById('msg-text');
    const body = t.value.trim(); if(!body) return;
    const { error } = await supabase.from('messages').insert({ body });
    if (!error) { t.value=''; loadMessages(); }
  });

  // Realtime updates (optional)
  const channel = supabase.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, loadMessages).subscribe();

  // Init
  (async ()=>{
    const authed = await handleHashSession();
    setAuthedUI(authed);
    if (authed) { await listProjects(); await listDocuments(); await loadMessages(); }
  })();
  </script>
</body>
</html>
